<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #2563eb; --success: #16a34a; --danger: #dc2626;
        --bg: #f3f4f6; --border: #e5e7eb; --text: #1f2937;
      }
      * { box-sizing: border-box; }
      body {
        font-family: 'Inter', sans-serif; margin: 0; padding: 0;
        height: 100vh; display: flex; flex-direction: column;
        background: #fff; color: var(--text); overflow: hidden;
      }

      /* HEADER */
      header {
        height: 50px; background: #fff; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 20px; flex-shrink: 0;
      }
      .brand { font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-size: 14px;}
      .sheet-badge { background: var(--bg); padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }

      /* MAIN LAYOUT */
      .main-container { display: flex; flex: 1; height: calc(100vh - 50px); }

      /* SIDEBAR */
      .sidebar {
        width: 320px; background: var(--bg); border-right: 1px solid var(--border);
        display: flex; flex-direction: column; flex-shrink: 0;
      }
      .sidebar-actions { padding: 15px; background: #fff; border-bottom: 1px solid var(--border); }
      .btn-new-big {
        width: 100%; padding: 12px; background: var(--success); color: white;
        border: none; border-radius: 6px; font-weight: 700; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .btn-new-big:active { transform: scale(0.98); }
      
      .search-wrapper { padding: 10px 15px; border-bottom: 1px solid var(--border); }
      #search-box { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
      
      .list-container { flex: 1; overflow-y: auto; background: #fff; }
      .list-item {
        padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer;
      }
      .list-item:hover { background: #f9fafb; }
      .list-item.active { background: #eff6ff; border-left: 4px solid var(--primary); }
      .list-item strong { display: block; font-size: 14px; color: #111; }
      .list-item span { font-size: 11px; color: #6b7280; }

      /* CONTENT FORM */
      .content-area { flex: 1; display: flex; flex-direction: column; background: #fff; }
      .form-header { padding: 15px 30px; border-bottom: 1px solid var(--border); }
      .form-title { font-size: 18px; font-weight: 700; margin: 0; }
      .form-subtitle { font-size: 12px; color: #6b7280; margin-top: 4px; }
      
      .form-scroller { flex: 1; overflow-y: auto; padding: 30px; }
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .form-group { display: flex; flex-direction: column; }
      .form-group.full { grid-column: span 2; }
      
      label { font-size: 11px; font-weight: 700; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; }
      input, select { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; width: 100%; }
      input:focus { border-color: var(--primary); outline: 2px solid #bfdbfe; }
      input[readonly] { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }

      /* FOOTER */
      .sticky-footer {
        padding: 15px 30px; background: #fff; border-top: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05); z-index: 10;
      }
      .btn-delete {
        background: transparent; color: var(--danger); border: 1px solid var(--danger);
        padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;
        opacity: 0.5; pointer-events: none;
      }
      .btn-delete.active { opacity: 1; pointer-events: auto; }
      .btn-delete:hover { background: #fef2f2; }
      
      .btn-save {
        padding: 12px 30px; border-radius: 6px; font-weight: 700; color: white;
        border: none; cursor: pointer; font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .mode-create .btn-save { background: var(--success); }
      .mode-edit .btn-save { background: var(--primary); }

      /* LOADER */
      #loader {
        position: fixed; inset: 0; background: rgba(255,255,255,0.95);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 999;
      }
      .spinner {
        width: 40px; height: 40px; border: 4px solid #e5e7eb;
        border-top-color: var(--primary); border-radius: 50%;
        animation: spin 0.8s linear infinite; margin-bottom: 15px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>

    <div id="loader">
      <div class="spinner"></div>
      <div id="loader-msg" style="font-weight:600; color:#4b5563;">Connecting...</div>
    </div>

    <header>
      <div class="brand">LAD Database</div>
      <div class="sheet-badge" id="sheet-name-display">Loading...</div>
    </header>

    <div class="main-container">
      
      <div class="sidebar">
        <div class="sidebar-actions">
          <button class="btn-new-big" onclick="initNewRecord()"><span>+</span> NEW RECORD</button>
        </div>
        <div class="search-wrapper">
          <input type="text" id="search-box" placeholder="üîç Search..." onkeyup="filterList()" autocomplete="off">
        </div>
        <div class="list-container" id="list-container"></div>
      </div>

      <form class="content-area mode-create" id="main-form" onsubmit="handleSave(event)">
        <input type="hidden" name="sheetName" id="hidden-sheet-name">

        <div class="form-header">
          <h2 class="form-title" id="form-title">New Entry</h2>
          <div class="form-subtitle" id="form-subtitle">Fill in details. ID generates automatically.</div>
        </div>

        <div class="form-scroller">
          <div class="form-grid" id="form-grid"></div>
        </div>

        <div class="sticky-footer">
          <button type="button" class="btn-delete" id="btn-delete" onclick="handleDelete()">üóë Delete</button>
          <button type="submit" class="btn-save" id="btn-save">‚úÖ SAVE RECORD</button>
        </div>
      </form>

    </div>

    <script>
      let currentData = [];
      let currentColumns = [];

      window.onload = startUp;

      function startUp() {
        google.script.run.withSuccessHandler(initUI).withFailureHandler(showError).getSheetData();
      }

      function initUI(response) {
        if (response.error) return showError(response.error);
        
        currentColumns = response.columns;
        currentData = response.data;
        
        // SET SHEET NAME VISIBLY AND HIDDEN
        document.getElementById('sheet-name-display').innerText = response.sheetName;
        document.getElementById('hidden-sheet-name').value = response.sheetName;

        buildForm(currentColumns);
        renderList(currentData);
        initNewRecord();
        
        document.getElementById('loader').style.display = 'none';
      }

      function buildForm(cols) {
        const grid = document.getElementById('form-grid');
        grid.innerHTML = '';
        
        cols.forEach((col, i) => {
          const div = document.createElement('div');
          div.className = 'form-group';
          if (i === 0 || /description|address|note/i.test(col.name)) div.classList.add('full');

          const label = document.createElement('label');
          label.innerText = col.name;
          div.appendChild(label);

          let input;
          if (col.options && col.options.length > 0) {
            input = document.createElement('select');
            input.innerHTML = '<option value="">- Select -</option>';
            col.options.forEach(opt => {
              const o = document.createElement('option');
              o.value = (typeof opt === 'object') ? opt.id : opt;
              o.text = (typeof opt === 'object') ? opt.name : opt;
              input.appendChild(o);
            });
          } else {
            input = document.createElement('input');
            input.type = 'text';
          }

          input.id = 'field-' + i;
          input.name = 'col-' + i;
          
          if (i === 0) {
            input.readOnly = true;
            input.placeholder = "(Auto-ID)";
            input.style.fontFamily = "monospace";
          }
          div.appendChild(input);
          grid.appendChild(div);
        });
      }

function renderList(data) {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        
        if (data.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No records found.</div>';
          return;
        }

        // 1. FIND THE BEST COLUMNS FOR THE TITLE
        // We look for column headers that contain "name", "title", or "email"
        let titleIdx = -1;
        const potentialHeaders = ['name', 'title', 'artist', 'product', 'original', 'email'];
        
        // Loop through currentColumns to find a match
        for (let key of potentialHeaders) {
           const found = currentColumns.findIndex(c => c.name.toLowerCase().includes(key));
           if (found > 0) { // > 0 because 0 is ID
             titleIdx = found;
             break;
           }
        }
        // Fallback: If no "name" column found, use Column 1 (index 1), or Column 2
        if (titleIdx === -1) titleIdx = 1;

        data.forEach(row => {
          const el = document.createElement('div');
          el.className = 'list-item';
          
          // Use the smart index we found
          const title = row[titleIdx] || row[titleIdx + 1] || "Unnamed Record";
          const id = row[0];
          
          el.innerHTML = `<strong>${title}</strong><span>${id}</span>`;
          el.onclick = () => loadRecord(row, el);
          container.appendChild(el);
        });
      }
      function initNewRecord() {
        document.getElementById('main-form').reset();
        // Reset hidden sheet name after reset()
        document.getElementById('hidden-sheet-name').value = document.getElementById('sheet-name-display').innerText;
        
        document.getElementById('main-form').className = 'content-area mode-create';
        document.getElementById('form-title').innerText = "üÜï New Entry";
        document.getElementById('form-subtitle').innerText = "Create a new record.";
        document.getElementById('btn-save').innerText = "‚úÖ SAVE RECORD";
        document.getElementById('btn-delete').classList.remove('active');
        document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active'));
      }

      function loadRecord(row, element) {
        document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active'));
        element.classList.add('active');

        currentColumns.forEach((col, i) => {
          const field = document.getElementById('field-' + i);
          if (field) {
            let val = row[i];
            if (typeof val === 'string' && val.includes('T00:00')) val = val.split('T')[0];
            field.value = val;
          }
        });

        document.getElementById('main-form').className = 'content-area mode-edit';
        document.getElementById('form-title').innerText = `‚úèÔ∏è Edit: ${row[1] || row[2] || 'Item'}`;
        document.getElementById('form-subtitle').innerText = `ID: ${row[0]}`;
        document.getElementById('btn-save').innerText = "üíæ UPDATE CHANGES";
        document.getElementById('btn-delete').classList.add('active');
      }

      function handleSave(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-save');
        const isNew = document.getElementById('main-form').classList.contains('mode-create');
        
        btn.disabled = true;
        btn.innerText = isNew ? "Adding..." : "Updating...";
        showLoader(true, isNew ? "Creating..." : "Saving...");

        google.script.run
          .withSuccessHandler((res) => {
             if(res.error) { showError(res.error); } 
             else { startUp(); }
             btn.disabled = false;
          })
          .withFailureHandler(err => {
             showError(err.message);
             btn.disabled = false;
          })
          .processForm(document.getElementById('main-form'));
      }

      function handleDelete() {
        const id = document.getElementById('field-0').value;
        if (!id) return;
        if (confirm("Permanently delete this record?")) {
          showLoader(true, "Deleting...");
          google.script.run.withSuccessHandler(startUp).deleteItem(id);
        }
      }

      function filterList() {
        const q = document.getElementById('search-box').value.toLowerCase();
        document.querySelectorAll('.list-item').forEach(item => {
          item.style.display = item.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        });
      }

      function showLoader(show, msg) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loader-msg').innerText = msg;
      }

      function showError(err) {
        showLoader(false);
        alert("‚ö†Ô∏è Error: " + err);
      }
    </script>
  </body>
</html>
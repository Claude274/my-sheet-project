<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden">

  <nav class="bg-white border-b p-4 flex items-center justify-between shadow-sm z-10">
    <div class="flex items-center gap-6 flex-1">
      <h1 class="text-xl font-bold text-slate-800"><i class="fas fa-shopping-bag text-blue-600 mr-2"></i>LAD Order</h1>
      <div class="relative w-full max-w-md">
        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
        <input type="text" id="skuSearch" onkeyup="filterProducts()" placeholder="Filter by SKU..." 
               class="w-full pl-10 pr-4 py-2 border rounded-full bg-slate-100 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
      </div>
    </div>
    <select id="contactSelect" class="border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 mr-4"></select>
  </nav>

  <div class="flex flex-1 overflow-hidden">
    <main class="flex-1 p-6 overflow-y-auto custom-scroll">
      <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </main>

    <aside class="w-80 bg-white border-l shadow-xl flex flex-col">
      <div class="p-4 border-b bg-slate-50 font-bold text-slate-700">Shopping Basket</div>
      <div id="basketItems" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll"></div>
      
      <div class="p-6 border-t bg-slate-50 space-y-4">
        <textarea id="orderComment" class="w-full border rounded-lg p-3 text-sm h-24 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add order comments..."></textarea>
        <div class="flex justify-between text-2xl font-black text-slate-800">
          <span>Total:</span><span><span id="totalDisplay">0</span>€</span>
        </div>
        <button onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
          Complete Purchase
        </button>
      </div>
    </aside>
  </div>

  <script>
    let inventory = []; let basket = [];

    window.onload = () => {
      google.script.run.withSuccessHandler(list => {
        const sel = document.getElementById('contactSelect');
        list.forEach(c => sel.add(new Option(c.name, c.id)));
      }).getContactsForOrder();

      google.script.run.withSuccessHandler(items => {
        inventory = items;
        renderGrid(items);
      }).getInventoryForOrder();
    };

    function renderGrid(items) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = items.map(item => `
        <div class="bg-white border rounded-2xl p-4 hover:shadow-lg transition group">
          <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">${item.id.substring(0,8)}</div>
          <div class="text-slate-900 font-bold mb-4 h-12 overflow-hidden">${item.sku}</div>
          <div class="flex items-center justify-between">
            <span class="text-xl font-bold text-blue-600">${item.price}€</span>
            <button onclick="addToBasket('${item.id}')" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-full font-bold hover:bg-blue-600 hover:text-white transition">Add</button>
          </div>
        </div>
      `).join('');
    }

    function filterProducts() {
      const q = document.getElementById('skuSearch').value.toLowerCase();
      renderGrid(inventory.filter(i => i.sku.toLowerCase().includes(q)));
    }

    function addToBasket(id) {
      const item = inventory.find(i => i.id === id);
      if (item) { basket.push(item); updateBasketUI(); }
    }

    function removeFromBasket(idx) { basket.splice(idx, 1); updateBasketUI(); }

    function updateBasketUI() {
      const total = basket.reduce((sum, i) => sum + parseFloat(i.price), 0);
      document.getElementById('basketItems').innerHTML = basket.map((i, idx) => `
        <div class="flex justify-between items-center text-sm border-b pb-2">
          <div class="truncate w-40 font-medium">${i.sku}</div>
          <button onclick="removeFromBasket(${idx})" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>
        </div>
      `).join('');
      document.getElementById('totalDisplay').innerText = total;
    }

    function submitOrder() {
      if (basket.length === 0) return alert("Basket is empty!");
      const data = {
        contact_id: document.getElementById('contactSelect').value,
        contact_name: document.getElementById('contactSelect').options[document.getElementById('contactSelect').selectedIndex].text,
        itemIds: basket.map(i => i.id),
        skuList: basket.map(i => i.sku).join(', '),
        total: document.getElementById('totalDisplay').innerText,
        comment: document.getElementById('orderComment').value
      };
      google.script.run.withSuccessHandler(() => google.script.host.close()).processSaveOrder(data);
    }
  </script>
</body>
</html>